<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales Forecast</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f0f4f8, #c7e0e8);
            color: #333;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: auto;
        }

        h3 {
            color: #444;
        }

        canvas {
            margin-bottom: 10px;
        }

        button {
            padding: 8px 12px;
            background-color: #337ab7;
            color: white;
            border: none;
            border-radius: 5px;
            margin: 10px 0;
            cursor: pointer;
        }

        .forecast-text {
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h3>Dry Season Sales Forecast (December to May)</h3>
        <canvas id="drySeasonSalesChart"></canvas>
        <p class="forecast-text" id="drySeasonForecast">Dry Season Forecast Sales: <span></span></p>

        <h3>Rainy Season Sales Forecast (June to November)</h3>
        <canvas id="rainySeasonSalesChart"></canvas>
        <p class="forecast-text" id="rainySeasonForecast">Rainy Season Forecast Sales: <span></span></p>

        <button id="showCategoryTrends">Show Category Trends</button>
        <canvas id="categoryTrendsChart" style="display:none;"></canvas>
    </div>

    <script>
        async function fetchForecastData() {
            const response = await fetch('/forecast');
            return response.json();
        }

        async function fetchCategoryTrends(season) {
            const response = await fetch(`/category_trends/${season}`);
            return response.json();
        }

        async function renderCharts() {
            const forecastData = await fetchForecastData();

            const dry = forecastData.forecast_data.find(f => f.label.includes("Dry"));
            const rainy = forecastData.forecast_data.find(f => f.label.includes("Rainy"));

            // Update text content with forecast sales and trend
            document.getElementById('drySeasonForecast').children[0].textContent = `${dry.forecast_sales} (${dry.trend})`;
            document.getElementById('rainySeasonForecast').children[0].textContent = `${rainy.forecast_sales} (${rainy.trend})`;

            // Dry Season Sales Chart
            new Chart(document.getElementById('drySeasonSalesChart').getContext('2d'), {
                type: 'line',
                data: {
                    labels: forecastData.dry_season_specific_data.dates.concat(['Forecast']),
                    datasets: [{
                        label: 'Dry Season Sales',
                        data: forecastData.dry_season_specific_data.totals.concat(dry.forecast_sales),
                        borderColor: 'rgb(255,99,132)',
                        fill: false
                    }]
                }
            });

            // Rainy Season Sales Chart
            new Chart(document.getElementById('rainySeasonSalesChart').getContext('2d'), {
                type: 'line',
                data: {
                    labels: forecastData.rainy_season_specific_data.dates.concat(['Forecast']),
                    datasets: [{
                        label: 'Rainy Season Sales',
                        data: forecastData.rainy_season_specific_data.totals.concat(rainy.forecast_sales),
                        borderColor: 'rgb(54,162,235)',
                        fill: false
                    }]
                }
            });
        }

        document.getElementById('showCategoryTrends').addEventListener('click', async () => {
            const season = 'Dry Season';  // or 'Rainy Season'
            const categoryTrends = await fetchCategoryTrends(season);

            const categoryTrendsChart = new Chart(document.getElementById('categoryTrendsChart').getContext('2d'), {
                type: 'bar',
                data: {
                    labels: categoryTrends[0].dates,  // Assuming all categories have the same months
                    datasets: categoryTrends.map(cat => ({
                        label: cat.category,
                        data: cat.total_php,
                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                        borderColor: 'rgba(255, 99, 132, 1)',
                        borderWidth: 1
                    }))
                }
            });

            // Show the category trend chart
            document.getElementById('categoryTrendsChart').style.display = 'block';
        });

        renderCharts();
    </script>
</body>
</html>
