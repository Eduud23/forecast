<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales Forecast</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f0f4f8, #c7e0e8);
            color: #333;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: auto;
        }

        h3 {
            color: #444;
        }

        canvas {
            margin-bottom: 10px;
        }

        button {
            padding: 8px 12px;
            background-color: #337ab7;
            color: white;
            border: none;
            border-radius: 5px;
            margin: 10px 0;
            cursor: pointer;
        }

        ul {
            list-style-type: none;
            padding-left: 10px;
        }

        li {
            margin: 4px 0;
        }

        .forecast-text {
            font-weight: bold;
        }

        .toggle-section {
            display: none;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h3>Dry Season Sales Forecast (December to May)</h3>
        <canvas id="drySeasonSalesChart"></canvas>
        <p class="forecast-text" id="drySeasonForecast">Dry Season Forecast Sales: <span></span></p>

        <button onclick="toggleUnitsForecast('dry')">Toggle Dry Season Unit Forecast</button>
        <div id="dryUnitsSection" class="toggle-section">
            <canvas id="drySeasonUnitsChart"></canvas>
        </div>

        <h3>Rainy Season Sales Forecast (June to November)</h3>
        <canvas id="rainySeasonSalesChart"></canvas>
        <p class="forecast-text" id="rainySeasonForecast">Rainy Season Forecast Sales: <span></span></p>

        <button onclick="toggleUnitsForecast('rainy')">Toggle Rainy Season Unit Forecast</button>
        <div id="rainyUnitsSection" class="toggle-section">
            <canvas id="rainySeasonUnitsChart"></canvas>
        </div>

        <h3>Next Month Sales Forecast</h3>
        <canvas id="nextMonthSalesChart"></canvas>
        <p class="forecast-text" id="nextMonthForecast">Next Month Forecast Sales: <span></span></p>

        <button onclick="toggleUnitsForecast('next')">Toggle Next Month Unit Forecast</button>
        <div id="nextUnitsSection" class="toggle-section">
            <canvas id="nextMonthUnitsChart"></canvas>
        </div>
    </div>

    <script>
        async function fetchForecastData() {
            const response = await fetch('/forecast');
            return response.json();
        }

        async function fetchUnitForecastData() {
            const response = await fetch('/forecast-units');
            return response.json();
        }

        function toggleUnitsForecast(season) {
            const sectionId = {
                dry: 'dryUnitsSection',
                rainy: 'rainyUnitsSection',
                next: 'nextUnitsSection'
            }[season];

            const chartId = {
                dry: 'drySeasonUnitsChart',
                rainy: 'rainySeasonUnitsChart',
                next: 'nextMonthUnitsChart'
            }[season];

            const section = document.getElementById(sectionId);
            if (section.style.display === 'none') {
                section.style.display = 'block';
                renderUnitChart(season, chartId);
            } else {
                section.style.display = 'none';
            }
        }

        async function renderCharts() {
            const forecastData = await fetchForecastData();

            const dry = forecastData.forecast_data.find(f => f.label.includes("Dry"));
            const rainy = forecastData.forecast_data.find(f => f.label.includes("Rainy"));
            const next = forecastData.forecast_data.find(f => f.label.includes("Next"));

            document.getElementById('drySeasonForecast').children[0].textContent = `${dry.forecast_sales} (${dry.trend})`;
            document.getElementById('rainySeasonForecast').children[0].textContent = `${rainy.forecast_sales} (${rainy.trend})`;
            document.getElementById('nextMonthForecast').children[0].textContent = `${next.forecast_sales} (${next.trend})`;

            new Chart(document.getElementById('drySeasonSalesChart').getContext('2d'), {
                type: 'line',
                data: {
                    labels: forecastData.dry_season_specific_data.dates.concat(['Forecast']),
                    datasets: [{
                        label: 'Dry Season Sales',
                        data: forecastData.dry_season_specific_data.sales.concat(dry.forecast_sales),
                        borderColor: 'rgb(255,99,132)',
                        fill: false
                    }]
                }
            });

            new Chart(document.getElementById('rainySeasonSalesChart').getContext('2d'), {
                type: 'line',
                data: {
                    labels: forecastData.rainy_season_specific_data.dates.concat(['Forecast']),
                    datasets: [{
                        label: 'Rainy Season Sales',
                        data: forecastData.rainy_season_specific_data.sales.concat(rainy.forecast_sales),
                        borderColor: 'rgb(54,162,235)',
                        fill: false
                    }]
                }
            });

            new Chart(document.getElementById('nextMonthSalesChart').getContext('2d'), {
                type: 'line',
                data: {
                    labels: forecastData.historical_data.dates.concat(['Forecast']),
                    datasets: [{
                        label: 'Monthly Sales',
                        data: forecastData.historical_data.sales.concat(next.forecast_sales),
                        borderColor: 'rgb(75,192,192)',
                        fill: false
                    }]
                }
            });
        }

        async function renderUnitChart(season, chartId) {
            const forecastUnits = await fetchUnitForecastData();
            let data = [];

            if (season === 'dry') data = forecastUnits["Dry Season"];
            else if (season === 'rainy') data = forecastUnits["Rainy Season"];
            else if (season === 'next') data = forecastUnits["Next Month"];

            new Chart(document.getElementById(chartId).getContext('2d'), {
                type: 'bar',
                data: {
                    labels: data.map(d => d.category),
                    datasets: [{
                        label: `${season.charAt(0).toUpperCase() + season.slice(1)} Unit Forecasts`,
                        data: data.map(d => d.forecast_units),
                        backgroundColor: 'rgba(100,149,237,0.6)',
                        borderColor: 'rgba(100,149,237,1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        renderCharts();
    </script>
</body>
</html>
